app-id: com.sigil_ebook.Sigil
runtime: org.kde.Platform
runtime-version: 5.15-22.08
sdk: org.kde.Sdk
base: com.riverbankcomputing.PyQt.BaseApp
base-version: 5.15-22.08
rename-desktop-file: sigil.desktop
rename-icon: sigil
command: sigil
finish-args:
  - --socket=fallback-x11
  - --socket=wayland
  - --share=ipc
  - --share=network
  - --device=dri
  - --filesystem=home
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
  - --env=PATH=/app/jre/bin:/usr/bin:/app/bin

add-extensions:
  org.freedesktop.Sdk.Extension.openjdk17:
    version: '22.08'
    directory: jdk # this is relative to /app
    no-autodownload: true

cleanup-commands:
  - ${FLATPAK_DEST}/cleanup-BaseApp.sh
  - ls -d -1 ${FLATPAK_DEST}/translations/qtwebengine_locales/* | grep -v en-US |
    xargs rm

modules:
  - name: jre
    buildsystem: simple
    build-commands:
      - mkdir -p /app/jdk
      - ln -s jdk/jvm/openjdk-17 /app/jre

  - name: sigil
    buildsystem: cmake-ninja
    config-opts:
      - -DUSE_SYSTEM_LIBS=0
      - -DDISABLE_UPDATE_CHECK=1
      - -DINSTALL_HICOLOR_ICONS=1
    post-install:
      - install -Dm644 ${FLATPAK_ID}.metainfo.xml -t ${FLATPAK_DEST}/share/metainfo
    sources:
      - type: archive
        url: https://github.com/Sigil-Ebook/Sigil/archive/1.9.30.tar.gz
        sha256: 262c43ec0ce9ea9486fc19074dd0a687a39d9df1829732e9006d8c5fbb242458
        x-checker-data:
          type: json
          is-main-source: true
          url: https://api.github.com/repos/Sigil-Ebook/Sigil/releases/latest
          version-query: .tag_name
          url-query: '"https://github.com/Sigil-Ebook/Sigil/archive/" + $version +
            ".tar.gz"'
          timestamp-query: .published_at

      - type: shell
        commands:
          - sed -i "s/sigil.desktop/$FLATPAK_ID.desktop/g" src/main.cpp

      - type: file
        path: com.sigil_ebook.Sigil.metainfo.xml

    modules:
      - dependencies/sigil-pypi-dependencies.json
      - dependencies/python3-tkinter.yaml
